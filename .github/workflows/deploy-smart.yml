name: Build & Deploy to cPanel (Multiple Domains)

on:
  push:
    branches: [ main ]

jobs:
  load-config:
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.set-matrix.outputs.matrix }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Load domain configuration
        id: set-matrix
        run: |
          CONFIG=$(cat .github/workflows/domains-config.json)
          DOMAINS=$(echo $CONFIG | jq -c '.domains')
          echo "matrix={\"include\":$DOMAINS}" >> $GITHUB_OUTPUT

  deploy:
    needs: load-config
    runs-on: ubuntu-latest
    timeout-minutes: 30
    strategy:
      matrix: ${{ fromJson(needs.load-config.outputs.matrix) }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: |
            rzfrontend/package-lock.json
            rzbackend/package-lock.json

      - name: Install Frontend Dependencies
        run: |
          cd rzfrontend
          npm ci

      - name: Create .env.local for build
        run: |
          cd rzfrontend
          cat > .env.local << EOF
          NEXT_PUBLIC_BASE_URL=https://${{ matrix.domain }}
          API_BASE_URL=https://api.${{ matrix.domain }}/api/v1
          NEXT_PUBLIC_API_BASE_URL=https://api.${{ matrix.domain }}/api/v1
          NEXT_PUBLIC_IMAGE_DOMAIN=api.${{ matrix.domain }}
          EOF
          echo "Created .env.local with domain-specific variables"
          cat .env.local

      - name: Build Next.js Frontend
        run: |
          cd rzfrontend
          npm run build

      - name: Install Backend Dependencies (if exists)
        run: |
          cd rzbackend && npm ci || echo "No backend folder - skipping"
        continue-on-error: true

      - name: Prepare production files (correct folder structure)
        run: |
          mkdir -p deploy-package

          # Frontend: copy entire folder (includes .next, public, src, and ALL other files)
          cp -r rzfrontend deploy-package/

          # Backend: copy entire folder (includes ALL files)
          if [ -d "rzbackend" ]; then
            cp -r rzbackend deploy-package/
          fi

      # Deploy via SFTP
      - name: Deploy via SFTP
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.CPANEL_HOST }}
          username: ${{ secrets.CPANEL_USERNAME }}
          password: ${{ secrets.CPANEL_PASSWORD }}
          port: 22
          source: "deploy-package/*"
          target: "/home/${{ secrets.CPANEL_USERNAME }}/public_html/${{ matrix.domain }}/"
          strip_components: 1
          overwrite: true

      # Fix permissions & restart apps
      - name: Fix permissions & restart Node.js apps
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.CPANEL_HOST }}
          username: ${{ secrets.CPANEL_USERNAME }}
          password: ${{ secrets.CPANEL_PASSWORD }}
          port: 22
          script: |
            DOMAIN="${{ matrix.domain }}"
            DOMAIN_PATH="$HOME/public_html/$DOMAIN"
            cd "$DOMAIN_PATH"

            echo "Deploying to: $DOMAIN_PATH"

            # Set proper permissions
            find . -type d -exec chmod 755 {} \;
            find . -type f -exec chmod 644 {} \;
            chmod 755 rzfrontend/.next/cache || true

            # Kill old processes using domain name
            pkill -f "node.*$DOMAIN" || true
            sleep 2

            # Start Backend
            if [ -d "rzbackend" ] && [ -f "rzbackend/package.json" ]; then
              cd rzbackend
              echo "Starting backend on port ${{ matrix.backend_port }}..."
              npm install --production --silent
              # PORT=${{ matrix.backend_port }} nohup npm start > "$DOMAIN_PATH/backend.log" 2>&1 &
              # echo $! > "$DOMAIN_PATH/backend.pid"
              cd "$DOMAIN_PATH"
            else
              echo "No backend found, skipping."
            fi

            # Start Frontend (must run from inside rzfrontend)
            if [ -d "rzfrontend" ] && [ -f "rzfrontend/package.json" ]; then
              cd rzfrontend
              echo "Starting frontend on port ${{ matrix.frontend_port }}..."
              npm install --production --silent
              # PORT=${{ matrix.frontend_port }} nohup npm start > "$DOMAIN_PATH/app.log" 2>&1 &
              # echo $! > "$DOMAIN_PATH/app.pid"
              cd "$DOMAIN_PATH"
            else
              echo "No frontend found!"
            fi

      #       # Final status
      #       echo "Deployed successfully: https://$DOMAIN"
      #       echo "Frontend PID: $(cat app.pid 2>/dev/null || echo 'N/A')"
      #       echo "Backend PID: $(cat backend.pid 2>/dev/null || echo 'N/A')"
      #       echo "Check logs: app.log | backend.log"