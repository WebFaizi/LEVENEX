name: Smart Deploy to Multiple Domains


on:
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    
    strategy:
      matrix:
        domain:
          - digitalstandeeonrent.in
          - rentalnearme.in

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 1

    - name: Deploy to cPanel (Node.js Fixed)
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.CPANEL_HOST }}
        username: ${{ secrets.CPANEL_USERNAME }}
        password: ${{ secrets.CPANEL_PASSWORD }}
        port: 22
        timeout: 300s
        command_timeout: 20m
        script: |
          # === FIX: gettext loop + clean environment ===
          export LC_ALL=C
          export LANG=C
          unset LANGUAGE
          exec bash --norc --noprofile -c "$(cat <<'EOF'

          set -e

          DOMAIN="${{ matrix.domain }}"
          DOMAIN_PATH="$HOME/public_html/$DOMAIN"

          echo "=== Deploying to $DOMAIN ==="
          echo "Path: $DOMAIN_PATH"

          # Go to domain directory
          mkdir -p "$DOMAIN_PATH"
          cd "$DOMAIN_PATH"

          # Git update
          if [ -d ".git" ]; then
            echo "Updating existing repo..."
            git config --global --add safe.directory "$DOMAIN_PATH"
            git fetch --all
            git reset --hard origin/main
            git clean -fd
            git pull origin main
          else
            echo "Cloning fresh repo..."
            cd "$HOME/public_html"
            rm -rf "$DOMAIN"
            git clone ${{ secrets.REPO_URL }} "$DOMAIN"
            cd "$DOMAIN"
          fi

          # === AUTO DETECT NODE.JS PATH (Works on 99% of cPanel servers) ===
          if [ -f "/usr/local/bin/npm" ]; then
            NPM_CMD="/usr/local/bin/npm"
            NODE_CMD="/usr/local/bin/node"
          elif [ -f "$HOME/.nvm/nvm.sh" ]; then
            . "$HOME/.nvm/nvm.sh"
            NPM_CMD="npm"
            NODE_CMD="node"
          elif command -v npm >/dev/null 2>&1; then
            NPM_CMD="npm"
            NODE_CMD="node"
          else
            echo "ERROR: npm not found! Please install Node.js via cPanel → Setup Node.js App"
            exit 1
          fi

          echo "Using npm: $NPM_CMD"
          echo "Using node: $NODE_CMD"

          # Set permissions
          find "$DOMAIN_PATH" -type d -exec chmod 755 {} \; 2>/dev/null || true
          find "$DOMAIN_PATH" -type f -exec chmod 644 {} \; 2>/dev/null || true

          # === MONOREPO: Frontend + Backend ===
          if [ -d "LAPTOPRENTALFRONTEND" ] && [ -d "LAPTOPRENTALBACKEND" ]; then
            echo "Monorepo detected"

            case "$DOMAIN" in
              "digitalstandeeonrent.in")  FRONTEND_PORT=3000; BACKEND_PORT=5000 ;;
              "rentalnearme.in")          FRONTEND_PORT=3001; BACKEND_PORT=5001 ;;
              *)                          FRONTEND_PORT=3002; BACKEND_PORT=5002 ;;
            esac

            # --- BACKEND ---
            echo "Deploying Backend → port $BACKEND_PORT"
            cd "$DOMAIN_PATH/LAPTOPRENTALBACKEND"
            $NPM_CMD ci --production 2>/dev/null || $NPM_CMD install --production
            pkill -f "${DOMAIN}-backend" || true
            sleep 2
            PORT=$BACKEND_PORT \
              nohup $NODE_CMD server.js > "$DOMAIN_PATH/backend.log" 2>&1 &
            echo $! > "$DOMAIN_PATH/backend.pid"
            echo "Backend started (PID: $(cat $DOMAIN_PATH/backend.pid))"

            # --- FRONTEND ---
            echo "Deploying Frontend → port $FRONTEND_PORT"
            cd "$DOMAIN_PATH/LAPTOPRENTALFRONTEND"
            $NPM_CMD ci --production 2>/dev/null || $NPM_CMD install --production
            $NPM_CMD run build
            pkill -f "${DOMAIN}-frontend" || true
            sleep 2
            PORT=$FRONTEND_PORT \
              nohup $NODE_CMD .next/standalone/server.js > "$DOMAIN_PATH/frontend.log" 2>&1 &
            echo $! > "$DOMAIN_PATH/frontend.pid"
            echo "Frontend started (PID: $(cat $DOMAIN_PATH/frontend.pid))"

            echo "DEPLOY SUCCESS: $DOMAIN"
            echo "Frontend: http://$DOMAIN:$FRONTEND_PORT"
            echo "Backend : http://$DOMAIN:$BACKEND_PORT"

          # === SINGLE APP ===
          else
            echo "Single app detected"
            PORT=3001
            [ "$DOMAIN" = "digitalstandeeonrent.in" ] && PORT=3000

            $NPM_CMD ci --production 2>/dev/null || $NPM_CMD install --production
            $NPM_CMD run build
            pkill -f "$DOMAIN" || true
            sleep 2
            PORT=$PORT nohup $NODE_CMD .next/standalone/server.js > "$DOMAIN_PATH/app.log" 2>&1 &
            echo $! > "$DOMAIN_PATH/app.pid"
            echo "App running on port $PORT (PID: $(cat $DOMAIN_PATH/app.pid))"
          fi

          echo "FULL DEPLOYMENT COMPLETED SUCCESSFULLY"
          EOF
          )"