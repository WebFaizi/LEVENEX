name: Build & Deploy to cPanel (Multiple Domains)

on:
  push:
    branches: [ main ]

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    strategy:
      matrix:
        domain:
          - digitalstandeeonrent.in
          - rentalnearme.in
        include:
          - domain: digitalstandeeonrent.in
            frontend_port: 3000
            backend_port: 5000
          - domain: rentalnearme.in
            frontend_port: 3001
            backend_port: 5001

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: |
            LAPTOPRENTALFRONTEND/package-lock.json
            LAPTOPRENTALBACKEND/package-lock.json

      - name: Install Frontend Dependencies
        run: |
          cd LAPTOPRENTALFRONTEND
          npm ci

      - name: Build Next.js Frontend
        run: |
          cd LAPTOPRENTALFRONTEND
          npm run build
        env:
          NEXT_PUBLIC_BASE_URL: https://${{ matrix.domain }}

      - name: Install Backend Dependencies (if exists)
        run: |
          cd LAPTOPRENTALBACKEND && npm ci || echo "No backend folder - skipping"
        continue-on-error: true

      - name: Prepare production files (correct folder structure)
        run: |
          mkdir -p deploy-package

          # Frontend: preserve folder structure
          mkdir -p deploy-package/LAPTOPRENTALFRONTEND
          cp -r LAPTOPRENTALFRONTEND/.next deploy-package/LAPTOPRENTALFRONTEND/
          cp -r LAPTOPRENTALFRONTEND/public deploy-package/LAPTOPRENTALFRONTEND/ || true
          cp LAPTOPRENTALFRONTEND/package.json deploy-package/LAPTOPRENTALFRONTEND/
          cp LAPTOPRENTALFRONTEND/package-lock.json deploy-package/LAPTOPRENTALFRONTEND/ || true
          cp LAPTOPRENTALFRONTEND/next.config.js deploy-package/LAPTOPRENTALFRONTEND/ || true
          cp LAPTOPRENTALFRONTEND/.env* deploy-package/LAPTOPRENTALFRONTEND/ || true

          # Backend: preserve folder
          mkdir -p deploy-package/LAPTOPRENTALBACKEND
          if [ -d "LAPTOPRENTALBACKEND" ]; then
            cp -r LAPTOPRENTALBACKEND/* deploy-package/LAPTOPRENTALBACKEND/ || true
          fi

      # Deploy via SFTP
      - name: Deploy via SFTP
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.CPANEL_HOST }}
          username: ${{ secrets.CPANEL_USERNAME }}
          password: ${{ secrets.CPANEL_PASSWORD }}
          port: 22
          source: "deploy-package/*"
          target: "/home/${{ secrets.CPANEL_USERNAME }}/public_html/${{ matrix.domain }}/"
          strip_components: 1
          overwrite: true

      # # Fix permissions & restart apps
      # - name: Fix permissions & restart Node.js apps
      #   uses: appleboy/ssh-action@v1.0.3
      #   with:
      #     host: ${{ secrets.CPANEL_HOST }}
      #     username: ${{ secrets.CPANEL_USERNAME }}
      #     password: ${{ secrets.CPANEL_PASSWORD }}
      #     port: 22
      #     script: |
      #       DOMAIN="${{ matrix.domain }}"
      #       DOMAIN_PATH="$HOME/public_html/$DOMAIN"
      #       cd "$DOMAIN_PATH"

      #       echo "Deploying to: $DOMAIN_PATH"

      #       # Set proper permissions
      #       find . -type d -exec chmod 755 {} \;
      #       find . -type f -exec chmod 644 {} \;
      #       chmod 755 LAPTOPRENTALFRONTEND/.next/cache || true

      #       # Kill old processes using domain name
      #       pkill -f "node.*$DOMAIN" || true
      #       sleep 2

      #       # Start Backend
      #       if [ -d "LAPTOPRENTALBACKEND" ] && [ -f "LAPTOPRENTALBACKEND/package.json" ]; then
      #         cd LAPTOPRENTALBACKEND
      #         echo "Starting backend on port ${{ matrix.backend_port }}..."
      #         npm install --production --silent
      #         PORT=${{ matrix.backend_port }} nohup npm start > "$DOMAIN_PATH/backend.log" 2>&1 &
      #         echo $! > "$DOMAIN_PATH/backend.pid"
      #         cd "$DOMAIN_PATH"
      #       else
      #         echo "No backend found, skipping."
      #       fi

      #       # Start Frontend (must run from inside LAPTOPRENTALFRONTEND)
      #       if [ -d "LAPTOPRENTALFRONTEND" ] && [ -f "LAPTOPRENTALFRONTEND/package.json" ]; then
      #         cd LAPTOPRENTALFRONTEND
      #         echo "Starting frontend on port ${{ matrix.frontend_port }}..."
      #         npm install --production --silent
      #         PORT=${{ matrix.frontend_port }} nohup npm start > "$DOMAIN_PATH/app.log" 2>&1 &
      #         echo $! > "$DOMAIN_PATH/app.pid"
      #         cd "$DOMAIN_PATH"
      #       else
      #         echo "No frontend found!"
      #       fi

      #       # Final status
      #       echo "Deployed successfully: https://$DOMAIN"
      #       echo "Frontend PID: $(cat app.pid 2>/dev/null || echo 'N/A')"
      #       echo "Backend PID: $(cat backend.pid 2>/dev/null || echo 'N/A')"
      #       echo "Check logs: app.log | backend.log"