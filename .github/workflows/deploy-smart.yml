name: Smart Deploy to Multiple Domains

on:
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    
    strategy:
      matrix:
        domain:
          - digitalstandeeonrent.in
          - rentalnearme.in

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 1

    - name: Debug Node.js Installation
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.CPANEL_HOST }}
        username: ${{ secrets.CPANEL_USERNAME }}
        password: ${{ secrets.CPANEL_PASSWORD }}
        port: 22
        script: |
          export LC_ALL=C
          echo "=== Checking Node.js Installation ==="
          echo "Home directory:"
          ls -la "$HOME" | grep -E "node|nvm"
          echo ""
          echo "Looking for nodevenv:"
          find "$HOME" -maxdepth 2 -name "nodevenv" -type d 2>/dev/null
          echo ""
          echo "Looking for node binaries:"
          find "$HOME" -name "node" -type f 2>/dev/null | head -5
          echo ""
          echo "PATH variable:"
          echo $PATH
          echo ""
          echo "Which node:"
          which node 2>/dev/null || echo "node not in PATH"
          echo ""
          echo "Which npm:"
          which npm 2>/dev/null || echo "npm not in PATH"

    - name: Deploy to cPanel (Node.js Fixed)
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.CPANEL_HOST }}
        username: ${{ secrets.CPANEL_USERNAME }}
        password: ${{ secrets.CPANEL_PASSWORD }}
        port: 22
        timeout: 300s
        command_timeout: 20m
        script: |
          # === FIX: gettext loop + clean environment ===
          export LC_ALL=C
          export LANG=C
          unset LANGUAGE
          exec bash --norc --noprofile -c "$(cat <<'EOF'

          set -e

          DOMAIN="${{ matrix.domain }}"
          DOMAIN_PATH="$HOME/public_html/$DOMAIN"

          echo "=== Deploying to $DOMAIN ==="
          echo "Path: $DOMAIN_PATH"

          # Go to domain directory
          mkdir -p "$DOMAIN_PATH"
          cd "$DOMAIN_PATH"

          # Git update
          if [ -d ".git" ]; then
            echo "Updating existing repo..."
            git config --global --add safe.directory "$DOMAIN_PATH"
            git fetch --all
            git reset --hard origin/main
            git clean -fd
            git pull origin main
          else
            echo "Cloning fresh repo..."
            cd "$HOME/public_html"
            rm -rf "$DOMAIN"
            git clone ${{ secrets.REPO_URL }} "$DOMAIN"
            cd "$DOMAIN"
          fi

          # === AUTO DETECT NODE.JS PATH (Works on 99% of cPanel servers) ===
          echo "Searching for Node.js installation..."
          
          # Method 1: cPanel Node.js App (most common)
          if [ -d "$HOME/nodevenv" ]; then
            echo "Found cPanel Node.js environment at: $HOME/nodevenv"
            
            # First, try to find activate script in domain-specific or public_html directories
            for search_path in \
              "$HOME/nodevenv/$DOMAIN" \
              "$HOME/nodevenv/public_html/$DOMAIN" \
              "$HOME/nodevenv/public_html" \
              "$HOME/nodevenv"/*
            do
              if [ -d "$search_path" ]; then
                echo "Checking: $search_path"
                # Look for bin/activate in nested structure
                for venv_dir in "$search_path"/*/bin "$search_path"/bin; do
                  if [ -f "$venv_dir/activate" ]; then
                    echo "Found activate script at: $venv_dir"
                    source "$venv_dir/activate"
                    NPM_CMD="npm"
                    NODE_CMD="node"
                    break 2
                  fi
                done
                
                # Look for direct node binary
                for venv_dir in "$search_path"/*/bin "$search_path"/bin; do
                  if [ -f "$venv_dir/node" ]; then
                    NPM_CMD="$venv_dir/npm"
                    NODE_CMD="$venv_dir/node"
                    export PATH="$venv_dir:$PATH"
                    echo "Using Node.js directly from: $venv_dir"
                    break 2
                  fi
                done
              fi
            done
          fi
          
          # Method 2: Try CloudLinux selector (alternative cPanel setup)
          if [ -z "$NPM_CMD" ] && [ -d "$HOME/nodevenv/$DOMAIN" ]; then
            # CloudLinux stores it differently
            CLOUDLINUX_NODE=$(find "$HOME/nodevenv/$DOMAIN" -name "node" -type f 2>/dev/null | head -1)
            if [ -n "$CLOUDLINUX_NODE" ]; then
              NODE_DIR=$(dirname "$CLOUDLINUX_NODE")
              NPM_CMD="$NODE_DIR/npm"
              NODE_CMD="$CLOUDLINUX_NODE"
              export PATH="$NODE_DIR:$PATH"
              echo "Found Node.js via CloudLinux at: $NODE_DIR"
            fi
          fi
          
          # Method 3: Check common cPanel paths
          if [ -z "$NPM_CMD" ]; then
            for nodepath in \
              /opt/cpanel/ea-nodejs20/bin \
              /opt/cpanel/ea-nodejs18/bin \
              /opt/cpanel/ea-nodejs16/bin \
              /usr/local/bin \
              /usr/bin
            do
              if [ -f "$nodepath/npm" ]; then
                NPM_CMD="$nodepath/npm"
                NODE_CMD="$nodepath/node"
                export PATH="$nodepath:$PATH"
                echo "Found Node.js at: $nodepath"
                break
              fi
            done
          fi
          
          # Method 4: Use NVM if available
          if [ -z "$NPM_CMD" ] && [ -f "$HOME/.nvm/nvm.sh" ]; then
            echo "Loading NVM..."
            export NVM_DIR="$HOME/.nvm"
            . "$HOME/.nvm/nvm.sh"
            nvm use --lts 2>/dev/null || nvm use default
            NPM_CMD="npm"
            NODE_CMD="node"
          fi
          
          # Method 5: Use system PATH
          if [ -z "$NPM_CMD" ]; then
            if command -v npm >/dev/null 2>&1; then
              NPM_CMD="npm"
              NODE_CMD="node"
              echo "Found Node.js in system PATH"
            fi
          fi
          
          # Final check
          if [ -z "$NPM_CMD" ]; then
            echo "ERROR: npm not found!"
            echo ""
            echo "Debug information:"
            echo "Domain: $DOMAIN"
            echo "Searched locations:"
            echo "  - $HOME/nodevenv/$DOMAIN"
            echo "  - $HOME/nodevenv/public_html/$DOMAIN"
            echo "  - /opt/cpanel/ea-nodejs*/bin"
            echo "  - System PATH"
            echo ""
            echo "nodevenv structure:"
            find "$HOME/nodevenv" -type f -name "node" 2>/dev/null || echo "No node binaries found"
            echo ""
            echo "Please ensure Node.js app is set up in cPanel for domain: $DOMAIN"
            exit 1
          fi

          echo "✓ Using npm: $NPM_CMD"
          echo "✓ Using node: $NODE_CMD"
          echo "✓ Node version: $($NODE_CMD --version)"
          echo "✓ NPM version: $($NPM_CMD --version)"

          # Set permissions
          find "$DOMAIN_PATH" -type d -exec chmod 755 {} \; 2>/dev/null || true
          find "$DOMAIN_PATH" -type f -exec chmod 644 {} \; 2>/dev/null || true

          # === MONOREPO: Frontend + Backend ===
          if [ -d "LAPTOPRENTALFRONTEND" ] && [ -d "LAPTOPRENTALBACKEND" ]; then
            echo "Monorepo detected"

            case "$DOMAIN" in
              "digitalstandeeonrent.in")  FRONTEND_PORT=3000; BACKEND_PORT=5000 ;;
              "rentalnearme.in")          FRONTEND_PORT=3001; BACKEND_PORT=5001 ;;
              *)                          FRONTEND_PORT=3002; BACKEND_PORT=5002 ;;
            esac

            # --- BACKEND ---
            echo "Deploying Backend → port $BACKEND_PORT"
            cd "$DOMAIN_PATH/LAPTOPRENTALBACKEND"
            $NPM_CMD ci --production 2>/dev/null || $NPM_CMD install --production
            pkill -f "${DOMAIN}-backend" || true
            sleep 2
            PORT=$BACKEND_PORT \
              nohup $NODE_CMD server.js > "$DOMAIN_PATH/backend.log" 2>&1 &
            echo $! > "$DOMAIN_PATH/backend.pid"
            echo "Backend started (PID: $(cat $DOMAIN_PATH/backend.pid))"

            # --- FRONTEND ---
            echo "Deploying Frontend → port $FRONTEND_PORT"
            cd "$DOMAIN_PATH/LAPTOPRENTALFRONTEND"
            $NPM_CMD ci --production 2>/dev/null || $NPM_CMD install --production
            $NPM_CMD run build
            pkill -f "${DOMAIN}-frontend" || true
            sleep 2
            PORT=$FRONTEND_PORT \
              nohup $NODE_CMD .next/standalone/server.js > "$DOMAIN_PATH/frontend.log" 2>&1 &
            echo $! > "$DOMAIN_PATH/frontend.pid"
            echo "Frontend started (PID: $(cat $DOMAIN_PATH/frontend.pid))"

            echo "DEPLOY SUCCESS: $DOMAIN"
            echo "Frontend: http://$DOMAIN:$FRONTEND_PORT"
            echo "Backend : http://$DOMAIN:$BACKEND_PORT"

          # === SINGLE APP ===
          else
            echo "Single app detected"
            PORT=3001
            [ "$DOMAIN" = "digitalstandeeonrent.in" ] && PORT=3000

            $NPM_CMD ci --production 2>/dev/null || $NPM_CMD install --production
            $NPM_CMD run build
            pkill -f "$DOMAIN" || true
            sleep 2
            PORT=$PORT nohup $NODE_CMD .next/standalone/server.js > "$DOMAIN_PATH/app.log" 2>&1 &
            echo $! > "$DOMAIN_PATH/app.pid"
            echo "App running on port $PORT (PID: $(cat $DOMAIN_PATH/app.pid))"
          fi

          echo "FULL DEPLOYMENT COMPLETED SUCCESSFULLY"
          EOF
          )"