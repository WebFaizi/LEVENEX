name: Smart Deploy to Multiple Domains

on:
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    
    strategy:
      matrix:
        domain:
          - digitalstandeeonrent.in
          - rentalnearme.in

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 1
        timeout: 600
    
    - name: Debug connection info
      run: |
        echo "Attempting to connect to host for domain: ${{ matrix.domain }}"
        echo "Using port: 22"
      
    - name: Check if domain exists and deploy
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.CPANEL_HOST }}
        username: ${{ secrets.CPANEL_USERNAME }}
        password: ${{ secrets.CPANEL_PASSWORD }}
        port: 22
        timeout: 300s
        command_timeout: 15m
        script: |
          set -e
          DOMAIN="${{ matrix.domain }}"
          DOMAIN_PATH="$HOME/public_html/$DOMAIN"
          
          echo "=== Deployment Information ==="
          echo "Domain: $DOMAIN"
          echo "Target path: $DOMAIN_PATH"
          echo "Current user: $(whoami)"
          echo "Home directory: $HOME"
          echo "=============================="
          
          # Check if domain directory exists
          if [ -d "$DOMAIN_PATH" ]; then
            echo "Domain $DOMAIN exists, updating code..."
            cd "$DOMAIN_PATH"
            
            # Check if git repo exists
            if [ -d ".git" ]; then
              echo "Git repository found, pulling latest changes..."
              git config --global --add safe.directory "$DOMAIN_PATH"
              git fetch origin
              git reset --hard origin/main
              git pull origin main
            else
              echo "No git repository found, cloning fresh..."
              cd "$HOME/public_html"
              rm -rf "$DOMAIN"
              mkdir -p "$DOMAIN"
              cd "$DOMAIN"
              git clone ${{ secrets.REPO_URL }} .
            fi
          else
            echo "Domain $DOMAIN not found, creating directory and cloning..."
            mkdir -p "$DOMAIN_PATH"
            cd "$DOMAIN_PATH"
            git clone ${{ secrets.REPO_URL }} .
          fi
          
          # Set proper permissions
          echo "Setting permissions..."
          find "$DOMAIN_PATH" -type d -exec chmod 755 {} \; 2>/dev/null || true
          find "$DOMAIN_PATH" -type f -exec chmod 644 {} \; 2>/dev/null || true
          
          echo "Deployment completed successfully for $DOMAIN"
          echo "Directory contents:"
          ls -la "$DOMAIN_PATH" | head -20